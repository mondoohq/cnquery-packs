packs:
  - uid: mondoo-asset-inventory-terraform-aws
    name: Terraform AWS Asset Inventory Pack
    version: 1.0.0
    authors:
      - name: Mondoo, Inc
        email: hello@mondoo.com
    tags:
      mondoo.com/platform: aws,cloud,terraform
      mondoo.com/category: asset-inventory
    docs:
      desc: |
        This inventory collects data from AWS Terraform state files and AWS accounts to build an asset inventory of resources managed by Terraform. 
    groups:
      - title: AWS Terraform State Inventory 
        filters: asset.platform == "terraform-state" && terraform.state.resources.any( providerName == "registry.terraform.io/hashicorp/aws" )
        checks:
          - uid: mondoo-asset-inventory-aws-default-network-acl-terraform-state
          - uid: mondoo-asset-inventory-aws-default-route-table-terraform-state
          - uid: mondoo-asset-inventory-aws-default-security-group-terraform-state
          - uid: mondoo-asset-inventory-aws-internet-gateway-terraform-state
          - uid: mondoo-asset-inventory-aws-nat-gateway-terraform-state
          - uid: mondoo-asset-inventory-aws-instance-terraform-state
          - uid: mondoo-asset-inventory-aws-s3-bucket-terraform-state
          - uid: mondoo-asset-inventory-aws-vpcs-terraform-state
      - title: AWS Runtime Inventory 
        filters: asset.platform == "aws"
        checks:
          - uid: mondoo-asset-inventory-aws-instance-runtime
          - uid: mondoo-asset-inventory-aws-s3-bucket-runtime
          - uid: mondoo-asset-inventory-aws-vpcs-runtime
    queries:
      - uid: mondoo-asset-inventory-aws-default-network-acl-terraform-state
        title: AWS Default Network ACLs 
        mql: terraform.state.resources.where( type == "aws_default_network_acl" ) { values['arn'] }
      - uid: mondoo-asset-inventory-aws-default-route-table-terraform-state
        title: AWS default route tables 
        mql: terraform.state.resources.where( type == "aws_default_route_table" ) { values['arn'] }
      - uid: mondoo-asset-inventory-aws-default-security-group-terraform-state
        title: AWS Default security group 
        mql: terraform.state.resources.where( type == "aws_default_security_group" ) { values['arn'] }
      - uid: mondoo-asset-inventory-aws-internet-gateway-terraform-state
        title: AWS Internet Gateways
        mql: terraform.state.resources.where( type == "aws_internet_gateway" ) { values['arn'] }
      - uid: mondoo-asset-inventory-aws-nat-gateway-terraform-state
        title: AWS Nat Gateways
        mql: terraform.state.resources.where( type == "aws_nat_gateway" ) { values['id'] }
      - uid: mondoo-asset-inventory-aws-instance-terraform-state
        title: AWS EC2 Instances managed by Terraform
        mql: terraform.state.resources.where( type == "aws_instance" ) { values['arn'] }
      - uid: mondoo-asset-inventory-aws-instance-runtime
        title: AWS EC2 Instances
        mql: aws.ec2.instances {arn}
      - uid: mondoo-asset-inventory-aws-s3-buckets-terraform-state
        title: AWS S3 Buckets managed by Terraform
        mql: terraform.state.resources.where( type == "aws_s3_bucket" ) { values['arn'] }
      - uid: mondoo-asset-inventory-aws-s3-buckets-runtime
        title: AWS S3 Buckets
        mql: aws.s3.buckets {arn}
      - uid: mondoo-asset-inventory-aws-vpcs-terraform-state
        title: AWS VPCs managed by Terraform
        mql: terraform.state.resources.where( type == "aws_vpc" ) { values['arn'] }
      - uid: mondoo-asset-inventory-aws-vpcs-runtime
        title: AWS VPCs
        mql: aws.vpcs { arn }